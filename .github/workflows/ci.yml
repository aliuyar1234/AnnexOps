name: CI

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: read

jobs:
  backend:
    name: Backend (lint, test, audit)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      BOOTSTRAP_TOKEN: test-bootstrap-token
      DATABASE_URL: postgresql+asyncpg://annexops:annexops@localhost:5433/annexops_test
      JWT_SECRET: ci-jwt-secret-not-for-production
      MINIO_ENDPOINT: localhost:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
      MINIO_BUCKET: annexops-attachments
      MINIO_USE_SSL: "false"

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: annexops
          POSTGRES_PASSWORD: annexops
          POSTGRES_DB: annexops_test
        ports:
          - 5433:5432
        options: >-
          --health-cmd="pg_isready -U annexops -d annexops_test"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11"]

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up Python
        uses: actions/setup-python@f677139bbe7f9c59b41e40162b753c062f5d49a3 # v5.2.0
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r backend/requirements.txt
          python -m pip install pre-commit pip-audit

      - name: Lint & format (pre-commit)
        run: pre-commit run --all-files --show-diff-on-failure

      - name: Start MinIO
        run: |
          docker run --detach --name minio \
            --publish 9000:9000 --publish 9001:9001 \
            --env MINIO_ROOT_USER="${MINIO_ACCESS_KEY}" \
            --env MINIO_ROOT_PASSWORD="${MINIO_SECRET_KEY}" \
            minio/minio:RELEASE.2025-09-07T16-13-09Z server /data --console-address ":9001"

      - name: Wait for MinIO
        run: |
          for i in {1..30}; do
            curl --fail http://localhost:9000/minio/health/ready >/dev/null && exit 0
            sleep 2
          done
          echo "MinIO did not become ready in time" >&2
          docker logs minio || true
          exit 1

      - name: Ensure S3 bucket exists
        run: |
          python - <<'PY'
          import boto3
          import os
          from botocore.config import Config

          endpoint = os.environ.get("MINIO_ENDPOINT", "localhost:9000")
          access_key = os.environ["MINIO_ACCESS_KEY"]
          secret_key = os.environ["MINIO_SECRET_KEY"]
          bucket = os.environ.get("MINIO_BUCKET", "annexops-attachments")

          client = boto3.client(
              "s3",
              endpoint_url=f"http://{endpoint}",
              aws_access_key_id=access_key,
              aws_secret_access_key=secret_key,
              region_name="us-east-1",
              config=Config(s3={"addressing_style": "path"}),
          )
          existing = {b["Name"] for b in client.list_buckets().get("Buckets", [])}
          if bucket not in existing:
              client.create_bucket(Bucket=bucket)
          PY

      - name: Tests
        run: |
          cd backend
          python -m pytest

      - name: Dependency audit
        run: python -m pip_audit -r backend/requirements.txt

      - name: Stop MinIO
        if: always()
        run: docker rm -f minio || true

  frontend:
    name: Frontend (lint, build)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up Node.js
        uses: actions/setup-node@a44ba7841725637a19e28fa30b79a866c81b0a6 # v4.0.4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Lint
        working-directory: frontend
        run: npm run lint

      - name: Build
        working-directory: frontend
        run: npm run build

  gitleaks:
    name: Secrets Scan (gitleaks)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@938557f6a58837331b99822ab17b8e536e7bef9 # v2.3.0
